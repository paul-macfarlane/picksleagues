# PicksLeagues — Tech Stack & Architecture

> This document defines the technology choices, project structure, and architectural patterns for building PicksLeagues. For business rules and feature behavior, see [BUSINESS_SPEC.md](./BUSINESS_SPEC.md). For background job details, see [BACKGROUND_JOBS.md](./BACKGROUND_JOBS.md).

---

## Stack Summary

| Layer           | Technology                                            |
| --------------- | ----------------------------------------------------- |
| Framework       | Next.js 16 (App Router)                               |
| Language        | TypeScript (strict mode)                              |
| Database        | PostgreSQL via Neon (serverless)                      |
| ORM             | Drizzle ORM                                           |
| Auth            | Better Auth (session-based, database-stored sessions) |
| Background Jobs | Inngest                                               |
| UI Components   | shadcn/ui (Radix primitives)                          |
| Styling         | Tailwind CSS v4                                       |
| Forms           | react-hook-form + @hookform/resolvers (Zod)           |
| Validation      | Zod                                                   |
| Date/Time       | date-fns + date-fns-tz                                |
| Testing         | Vitest                                                |
| Linting         | ESLint (next/core-web-vitals + next/typescript)       |
| Formatting      | Prettier                                              |
| Deployment      | Vercel                                                |
| Monitoring      | Sentry                                                |

---

## 1. Next.js 16 (App Router)

The app is a **single Next.js application** — no separate backend API. Server Components fetch data directly, Server Actions handle mutations, and API routes are used only for auth callbacks, Inngest webhook, and future mobile API access.

### Why Next.js

- Server Components eliminate the need for a separate API client layer for the web frontend
- Server Actions provide type-safe mutations without REST boilerplate
- File-based routing with layouts and loading states built in
- Native Vercel deployment with zero config
- Largest ecosystem for AI-assisted development

### Next.js 16 Specifics

- **All dynamic APIs are async (mandatory).** `params`, `searchParams`, `headers()`, `cookies()`, and `draftMode()` are Promises — synchronous access is fully removed in v16.
- **`PageProps` via `next typegen`.** Run `npx next typegen` to generate route-aware page prop types for type-safe `params`.
- **Turbopack** is the default dev bundler. No configuration needed.

### Key Patterns

- **Server Components** (default): All data fetching happens on the server. No `useEffect` + `fetch` patterns. Components are async and directly call database queries or service functions.
- **Server Actions**: All mutations (create league, submit picks, accept invite, etc.) are Server Actions. They validate input with Zod, perform the mutation, and `revalidatePath` / `revalidateTag` as needed.
- **Client Components**: Used only when interactivity is needed (pick selection toggles, form inputs, dropdowns, modals). Marked with `"use client"`. Keep these as leaf components.
- **API Routes**: Used sparingly — only for Better Auth handler, Inngest webhook endpoint, and any future endpoints needed by a mobile app.

---

## 2. Database: Drizzle ORM + Neon PostgreSQL

### Drizzle ORM

- Schema-first approach: define tables in TypeScript, generate migrations
- SQL-like query builder — no magic, predictable queries
- Type-safe: inferred types from schema, no manual type definitions
- Lightweight — no runtime overhead like Prisma's engine

### Neon

- Serverless PostgreSQL — scales to zero, no connection management needed
- Use `@neondatabase/serverless` driver for Vercel edge/serverless compatibility
- Connection pooling handled by Neon automatically

### Schema Organization

Define schema files per domain area:

```
src/lib/db/
├── index.ts              # Drizzle client instance
├── schema/
│   ├── auth.ts           # users, sessions, accounts, verifications (Better Auth managed)
│   ├── profiles.ts       # profiles
│   ├── sports.ts         # seasons, weeks, teams
│   ├── events.ts         # events, live_scores, outcomes
│   ├── odds.ts           # sportsbooks, odds
│   ├── leagues.ts        # leagues, league_members, league_invites
│   ├── picks.ts          # picks
│   ├── standings.ts      # standings
│   └── external.ts       # external_* bridge tables (ESPN ID mapping)
└── migrations/           # Generated by drizzle-kit
```

### Migrations

Use `drizzle-kit` for migration generation and management:

- `drizzle-kit generate` to create migrations from schema changes
- `drizzle-kit migrate` to apply migrations
- Migrations should be committed to the repo and applied as part of deployment

---

## 3. Auth: Better Auth

### Why Better Auth

- Database-first: sessions stored in PostgreSQL, not JWTs
- Clean Next.js integration via official plugin
- Built-in OAuth providers for Google and Discord
- Framework-agnostic core — works if we ever need a separate API for mobile
- Cross-subdomain cookie support

### Configuration

- **Providers**: Google, Discord
- **Session storage**: Database (sessions table managed by Better Auth)
- **Cookie strategy**: Cross-subdomain cookies for API/frontend on same domain
- **Callback flow**: After OAuth → `/api/v1/profiles/onboard` → create profile if needed → redirect to app

### Auth in Server Components

```ts
// Underlying Better Auth API:
const session = await auth.api.getSession({ headers: await headers() });
if (!session) redirect("/login");
```

In practice, wrap this in a `getSession()` helper (see [ARCHITECTURE.md Section 7](./ARCHITECTURE.md#7-authentication)) that throws `UnauthorizedError` when no session exists.

### Auth in Middleware

Use Next.js middleware to protect authenticated routes. Redirect to `/login` if no session. The `/login`, `/join/:token` preview, and auth callback routes remain public.

---

## 4. Background Jobs: Inngest

Inngest handles all scheduled and event-driven background work. See [BACKGROUND_JOBS.md](./BACKGROUND_JOBS.md) for full details.

### Setup

- Install `inngest` package
- Create an API route at `/api/inngest` to serve as the Inngest webhook
- Define functions in `src/lib/inngest/functions/`
- Inngest Dev Server for local development (`npx inngest-cli@latest dev`)

---

## 5. UI: shadcn/ui + Tailwind CSS v4

### shadcn/ui

- Not a dependency — components are copied into the project and owned by us
- Built on Radix UI primitives (accessible, unstyled)
- Customizable via Tailwind classes
- Key components used: Button, Card, Table, Dialog, Sheet, DropdownMenu, Select, Input, Avatar, Badge, Alert, Tabs, Collapsible, NavigationMenu, Popover, Command (combobox)

### Tailwind CSS v4

- Utility-first styling
- Dark mode support via `next-themes` (light/dark/system toggle)
- Use `cn()` utility (clsx + tailwind-merge) for conditional classes

### Toast Notifications

Use `sonner` for toast notifications (success/error feedback on mutations).

### Icons

Use `lucide-react` for icons.

---

## 6. Validation: Zod

Zod schemas serve triple duty:

1. **Server Action input validation**: Every Server Action validates its input with a Zod schema before processing
2. **Form validation**: Shared schemas between client forms and server actions for consistent validation
3. **Search param validation**: Route search params (e.g., `?weekId=`) validated with Zod

Define schemas alongside the domain they belong to (e.g., league schemas in the leagues feature area).

---

## 7. Project Structure

```
/
├── src/
│   ├── app/                          # Next.js App Router
│   │   ├── (public)/                 # Public routes (no auth required)
│   │   │   ├── login/
│   │   │   │   └── page.tsx          # OAuth login (Google, Discord)
│   │   │   └── join/
│   │   │       └── [token]/
│   │   │           └── page.tsx      # Invite link preview + join
│   │   ├── (app)/                    # Authenticated routes
│   │   │   ├── layout.tsx            # App shell (navbar, auth guard)
│   │   │   ├── page.tsx              # Home (invites + league preview)
│   │   │   ├── profile/
│   │   │   │   └── page.tsx          # Edit profile (?setup=true for onboarding)
│   │   │   ├── account/
│   │   │   │   └── page.tsx          # Account deletion
│   │   │   └── leagues/
│   │   │       ├── page.tsx          # My leagues list
│   │   │       ├── create/
│   │   │       │   └── page.tsx      # Create league form
│   │   │       └── [leagueId]/
│   │   │           ├── layout.tsx    # League shell (tabs, header)
│   │   │           ├── page.tsx      # Standings tab
│   │   │           ├── my-picks/
│   │   │           │   └── page.tsx  # My picks (with week navigation)
│   │   │           ├── league-picks/
│   │   │           │   └── page.tsx  # All members' picks
│   │   │           ├── members/
│   │   │           │   └── page.tsx  # Members + invite management
│   │   │           └── settings/
│   │   │               └── page.tsx  # League settings + delete
│   │   └── api/
│   │       ├── auth/
│   │       │   └── [...all]/
│   │       │       └── route.ts      # Better Auth handler
│   │       ├── inngest/
│   │       │   └── route.ts          # Inngest webhook
│   │       └── v1/                   # REST API (for future mobile app)
│   │           └── ...
│   ├── lib/
│   │   ├── db/                       # Drizzle schema, client, migrations
│   │   ├── auth.ts                   # Better Auth config + getSession helper
│   │   ├── inngest/                  # Inngest client + function definitions
│   │   ├── espn/                     # ESPN API client + data mapping
│   │   ├── scoring.ts               # Pick result calculation + standings points
│   │   ├── scheduling.ts            # Pick lock times, game window, week boundaries
│   │   ├── permissions.ts           # Membership, commissioner, capacity checks
│   │   ├── leagues.ts               # Season format resolution, rollover logic
│   │   └── validators/               # Shared Zod schemas
│   ├── actions/                      # Server Actions (orchestration: validate, auth, call data layer, revalidate)
│   │   ├── leagues.ts
│   │   ├── picks.ts
│   │   ├── invites.ts
│   │   ├── members.ts
│   │   ├── profiles.ts
│   │   └── account.ts
│   ├── data/                         # Data access layer (all Drizzle ORM code lives here)
│   │   ├── utils.ts
│   │   ├── leagues.ts
│   │   ├── picks.ts
│   │   ├── standings.ts
│   │   ├── events.ts
│   │   ├── teams.ts
│   │   ├── members.ts
│   │   ├── invites.ts
│   │   ├── profiles.ts
│   │   └── seasons.ts
│   └── components/                   # React components
│       ├── ui/                       # shadcn/ui base components
│       ├── app-layout.tsx            # Navbar, mobile menu, user dropdown
│       ├── picks/                    # Pick display, interactive pick cards
│       ├── leagues/                  # League cards, settings form
│       ├── standings/                # Standings table
│       ├── members/                  # Member list, invite forms
│       └── common/                   # Shared components (week switcher, etc.)
├── drizzle/                          # Generated migrations
├── docs/                             # Project documentation
│   ├── BUSINESS_SPEC.md
│   ├── ARCHITECTURE.md
│   ├── TECH_STACK.md
│   ├── BACKGROUND_JOBS.md
│   ├── WAYS_OF_WORKING.md
│   ├── BACKLOG.md
│   └── feedback/                     # Historical feedback per epic
├── drizzle.config.ts
└── vercel.json                       # Vercel config (rewrites if needed)
```

### Key Conventions

- **`data/`**: Data access layer — the **only** place Drizzle ORM code lives. Exports read functions (`get*`) and write functions (`insert*`, `update*`, `upsert*`, `remove*`). Called by pages, actions, and background jobs.
- **`actions/`**: Server Actions that orchestrate mutations. Each validates input with Zod, checks auth/permissions, calls `data/` functions, and calls `revalidatePath()`. No direct Drizzle calls.
- **`lib/`**: Shared business logic and config — auth helpers, scoring algorithms, scheduling rules, ESPN service, Zod schemas. ORM-free (except `lib/db/` which holds the schema and client).
- **`components/`**: React components. `ui/` contains shadcn primitives. Feature folders contain composed components.

---

## 8. Data Fetching Patterns

### Server Components (reads)

```tsx
// src/app/(app)/leagues/[leagueId]/page.tsx
import { getLeagueStandings } from "@/data/standings";
import { getSession } from "@/lib/auth";

export default async function StandingsPage(
  props: PageProps<"/leagues/[leagueId]">,
) {
  const { leagueId } = await props.params;
  const session = await getSession();
  const standings = await getLeagueStandings(leagueId);
  return <StandingsTable standings={standings} />;
}
```

### Server Actions (writes)

```tsx
// src/actions/picks.ts
"use server";

import { revalidatePath } from "next/cache";

import { insertPicks } from "@/data/picks";
import { getSession } from "@/lib/auth";
import { assertLeagueMember } from "@/lib/permissions";
import { SubmitPicksSchema } from "@/lib/validators/picks";

export async function submitPicks(
  input: SubmitPicksInput,
): Promise<ActionResult> {
  const validated = SubmitPicksSchema.parse(input);
  const session = await getSession();
  await assertLeagueMember(session.user.id, validated.leagueId);
  // ... business rule checks, then call data layer
  await insertPicks(
    validated.picks.map((p) => ({ ...p, userId: session.user.id })),
  );
  revalidatePath(`/leagues/${validated.leagueId}/my-picks`);
  return { success: true, data: undefined };
}
```

### Client Components (interactivity)

Only use `"use client"` for components that need browser APIs or event handlers (pick selection, form inputs, modals, theme toggle). Pass server-fetched data down as props.

---

## 9. Error Handling

### Error Classes

Define a small set of error classes for use in the data layer and actions:

- `BadRequestError` (400) — invalid input, failed validation
- `UnauthorizedError` (401) — no session
- `ForbiddenError` (403) — insufficient permissions
- `NotFoundError` (404) — resource doesn't exist

### Error Boundaries

Use Next.js `error.tsx` files per route segment. These catch errors thrown by Server Components or Actions and display user-friendly messages. Include a "Try again" option for retryable errors and a "Back to Home" fallback.

---

## 10. Deployment: Vercel

- **Build**: `next build` — standard Next.js build
- **Runtime**: Node.js serverless functions (not Edge — needed for Better Auth + Drizzle pg driver)
- **Environment Variables**: All secrets (database URL, auth secrets, OAuth credentials, Inngest keys, Sentry DSN) configured in Vercel dashboard
- **Domains**: Custom domain with cross-subdomain cookies for auth
- **Monitoring**: Sentry Next.js SDK with source maps uploaded at build time
